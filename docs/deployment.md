## Deploying Vitae NET

This document contains two methods of deploying Vitae NET. The first details
deployment with Travis CI, and the second deals with manual deployment.
Both methods make use of the scripts found in `scripts/`, and require
configuration files found in `deploy`. The server setup section of this
document may be skipped if you are working on a server with the app already
running, as that means those steps have been done for you.

### Server Setup

The deployment scripts assume a CentOS server with root access, and with `git`
and `mysql` (or `mariadb`) already installed. If these programs are
missing, you should install them with the following command.

```sh
yum install git mariadb mariadb-server
```

Then, set up `mysql` with two users `app` and `migration`, and create a database
called `vitaenet`. Note the passwords given to the users, as they are required
for deployment. Grant all privileges on `vitaenet` to `migration`, and grant
`select`, `delete`, `update`, and `insert` privileges on `vitaenet` to `app`.
If logged into `mysql` as `root`, this can be done with the following commands:

```
grant all on vitaenet.* to 'migration'@'localhost';
grant select, delete, update, insert on vitaenet.* to 'app'@'localhost';
flush privileges;
```

At this point, no further setup should be needed for `mysql`. Next, create
a user called `git` with `useradd git` and set their password with `passwd
git`.

Copy the contents of the `.travis/id_travis.pub` file in the Vitae NET
repository into the `~/.ssh/authorized_keys` file of both users, creating the
file if it does not exist. This is required for deployment with Travis CI to
work. If you are deploying manually, skip this step.

As the `git` user, create a bare repository called `vitae-net`:

```sh
git init --bare vitae-net
```

This will allow the repository to be pushed to by Travis CI.
At this point, server setup is complete and you are ready to deploy Vitae NET.

### Deploying with Travis CI

Deploying with Travis CI is a simple process. As long as all tests pass, you
can deploy. Travis is set to deploy on tags, so to deploy to the server (off of
`master`, say), all you need to do is

```sh
git tag <tagname>
git push --tags
```

Where `<tagname>` is the name of your tag. As long as that tag builds, Travis
will automatically deploy Vitae NET to the configured server. There are a few
configuration variables required:

* You must have an encrypted SSH key in the repository (follow the instructions
  at
[https://docs.travis-ci.com/user/encrypting-files/](https://docs.travis-ci.com/user/encrypting-files/)
for how to encrypt files) You can generate one (on Linux) with `ssh-keygen -t
rsa -b 4096 -f .travis/id_travis`. **DO NOT COMMIT THIS KEY! COMMIT THE
ENCRYPTED AND PUBLIC KEYS ONLY!** You should replace `.travis/id_travis.enc`
with the encrypted key generated by Travis CI and replace
`.travis/id_travis.pub` generated by `ssh-keygen` You may also need to remove
the old decryption command from the `before_install` section of `.travis.yml`.
Again, **DO NOT COMMIT THE PRIVATE KEY!**
* The environment variables `IP`, `PORT`, and `DEPLOY_DIR` should be set for
  the deployment server. These can be set in the Travis settings for the Vitae
  NET repository.
* The environment variables `APP_PASSWORD` and `MIGRATION_PASSWORD` should be
  set to the database passwords of the `app` and `migration` users. These can
  also be set in the Travis settings for the Vitae NET repository. They should
  not be shown in the output.

These should be configured already if the app is deployed using Travis, but
they are included here for the sake of completion.

### Deploying Manually

Deploying manually requires three steps. In all these commands, `$server` is
used to stand in for the IP address or hostname of the Vitae NET server.

1. Pull the latest changes from master to the server. This can be done with the
   following commands. Note that this uses SSH to push to the server so you
   will need to have a key set up and in the `git` user's
   `~/.ssh/authorized_keys` file for this to work.
```sh
git remote add deploy ssh://git@$server:$deploy_dir
git push deploy master
```
2. Install the system-level dependencies. This can be achieved by running
   `scripts/install-deps.sh` as the root user on the deployment server.
```sh
ssh root@$server 'bash -s' < scripts/install-deps.sh
```
3. Set up the application and its databases, if needed. This command uses the
   `git` user and requires the deployment directory (by default
   `/home/git/vitae-net`) and the passwords for the `app` and `migration` database
   users be passed as parameters.
``` sh
ssh git@$server 'bash -s' < scripts/setup-app.sh - $DEPLOY_DIR $APP_PASSWORD $MIGRATION_PASSWORD
```
4. Install the application into the web root.
```sh
ssh root@$server 'bash -s' < scripts/install-app.sh
```

This series of commands replicates what the Travis CI build does,
and should end up with the same result. The scripts will exit if any command
fails, so be aware that this could leave the application in an unworking state.
Don't deploy the application with the assumption that it will always work, and
be prepared to fix things if they fail.
